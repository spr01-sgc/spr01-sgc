/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.soma.transmisor.dao.impl.auxiliar;

import com.soma.transmisor.dao.auxiliar.BitacoraDaoAux;
import com.soma.transmisor.model.BitacoraPago;
import com.soma.transmisor.model.CausaRechazo;
import com.soma.transmisor.model.EstatusPago;
import com.soma.transmisor.model.Pago;
import com.soma.transmisor.model.Usuario;
import com.soma.transmisor.service.BitacoraPagoService;
import com.soma.transmisor.service.EstatusPagoService;
import com.soma.transmisor.service.PagoService;
import com.soma.transmisor.service.UsuarioService;
import java.util.Date;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 *
 * @author LUIS-SOMA
 */
@Service("bitacoraDaoAux")
@Transactional
public class BitacoraDaoImplAux implements BitacoraDaoAux {

    @Autowired
    UsuarioService usuarioService;
    @Autowired
    EstatusPagoService estatusPagoService;
    @Autowired
    BitacoraPagoService bitacoraPagoService;
    @Autowired
    PagoService pagoService;

    @Override
    public void bitacoraPago(String metodo, int pago, String user, boolean userAnonimo, String causaRechazo) {
        CausaRechazo causa = new CausaRechazo();
        BitacoraPago bitaPago = new BitacoraPago();
        if (!userAnonimo) {
            Date fecha = new Date();
            //Trae el usuario que ha inciado sesion
            Usuario usuarioid = usuarioService.busquedaNinckname(user);
            //del usuario se trae el id
            usuarioid.getUsuarioid();
            int estatusPag = 0;
            //dependiendo el metodo ejecutado se pasa el id de la accion realizada
            switch (metodo) {
                case "Pagado":
                    estatusPag = 1;
                    break;
                case "Enviado":
                    estatusPag = 2;
                    break;
                case "Cancelado":
                    estatusPag = 3;
                    break;
                case "Rechazado":
                    estatusPag = 4;
                    break;
                default:
                    break;
            }
            //se hace el insert a la tabla bitacoraAccionesUsuario
            EstatusPago estatus = estatusPagoService.buscaId(estatusPag);
            estatus.getEstatusid();
            bitaPago.setUsuarioid(usuarioid);
            bitaPago.setFecha(fecha);
            bitaPago.setEstatusid(estatus);
            Pago pag = pagoService.buscaId(pago);
            bitaPago.setPagoid(pag);
            if (bitacoraPagoService.save(bitaPago)) {
                if (metodo.equals("Cancelado")) {
                    causa.setDescripcion(causaRechazo);
                    causa.setBitapagoid(bitaPago);
                }
            }

        }
    }

}
