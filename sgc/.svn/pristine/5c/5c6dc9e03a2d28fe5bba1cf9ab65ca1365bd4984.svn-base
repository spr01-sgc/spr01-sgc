/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.soma.transmisor.controller;

import com.soma.transmisor.model.ActividadEco;
import com.soma.transmisor.model.Beneficiario;
import com.soma.transmisor.model.BitacoraPago;
import com.soma.transmisor.model.CausaRechazo;
import com.soma.transmisor.model.Ciudad;
import com.soma.transmisor.model.Cliente;
import com.soma.transmisor.model.CodigoPostal;
import com.soma.transmisor.model.Comision;
import com.soma.transmisor.model.Direccion;
import com.soma.transmisor.model.Estado;
import com.soma.transmisor.model.EstatusIdentificacion;
import com.soma.transmisor.model.EstatusPago;
import com.soma.transmisor.model.Giro;
import com.soma.transmisor.model.InstrumentoMonetario;
import com.soma.transmisor.model.MonedaDivisa;
import com.soma.transmisor.model.Pago;
import com.soma.transmisor.model.Persona;
import com.soma.transmisor.model.PersonaFisica;
import com.soma.transmisor.model.PersonaMoral;
import com.soma.transmisor.model.Sexo;
import com.soma.transmisor.model.Sucursal;
import com.soma.transmisor.model.Telefono;
import com.soma.transmisor.model.TipoIdentidad;
import com.soma.transmisor.model.TipoServicio;
import com.soma.transmisor.model.TipoTelefono;
import com.soma.transmisor.model.Usuario;
import com.soma.transmisor.model.ValorMoneda;
import com.soma.transmisor.service.ActividadEconomicaService;
import com.soma.transmisor.service.BeneficiarioService;
import com.soma.transmisor.service.BitacoraPagoService;
import com.soma.transmisor.service.CiudadService;
import com.soma.transmisor.service.ClienteService;
import com.soma.transmisor.service.CodigoPostalService;
import com.soma.transmisor.service.ComisionService;
import com.soma.transmisor.service.EstadoService;
import com.soma.transmisor.service.EstatusIdentificacionService;
import com.soma.transmisor.service.EstatusPagoService;
import com.soma.transmisor.service.GiroService;
import com.soma.transmisor.service.InstrumentoMonetarioService;
import com.soma.transmisor.service.MonedaDivisaService;
import com.soma.transmisor.service.PagoService;
import com.soma.transmisor.service.PersonaFisicaService;
import com.soma.transmisor.service.PersonaMoralService;
import com.soma.transmisor.service.PersonaService;
import com.soma.transmisor.service.SexoService;
import com.soma.transmisor.service.SucursalService;
import com.soma.transmisor.service.TipoServicioService;
import com.soma.transmisor.service.TipoTelefonoService;
import com.soma.transmisor.service.TiposIdentidadService;
import com.soma.transmisor.service.UsuarioService;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Formatter;
import java.util.List;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationTrustResolver;
import org.springframework.security.authentication.AuthenticationTrustResolverImpl;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * Administra los accesos a los JSP
 *
 * @author Luis Mendiola
 */
@Controller
@RequestMapping("/")
public class ControllerEnvios {

    @Autowired
    CodigoPostalService codigoPostalService;
    @Autowired
    SexoService sexoService;
    @Autowired
    TipoTelefonoService tipoTelefonoService;
    @Autowired
    InstrumentoMonetarioService instrumentomonetarioService;
    @Autowired
    MonedaDivisaService monedaDivisaService;
    @Autowired
    TipoServicioService tipoServicioService;
    @Autowired
    GiroService giroService;
    @Autowired
    ActividadEconomicaService actividadEconomicaService;
    @Autowired
    TiposIdentidadService tipoIdentidadService;
    @Autowired
    EstatusIdentificacionService estatusIdentificacionService;
    @Autowired
    CiudadService ciudadService;
    @Autowired
    PagoService pagoService;
    @Autowired
    SucursalService sucursalService;
    @Autowired
    ClienteService clienteService;
    @Autowired
    PersonaFisicaService personaFisicaService;
    @Autowired
    ClienteService clienteServiceClave;
    @Autowired
    PersonaService personaService;
    @Autowired
    PersonaMoralService personaMoralService;
    @Autowired
    ComisionService comisionService;
    @Autowired
    UsuarioService usuarioService;
    @Autowired
    EstadoService estadoService;
    @Autowired
    BeneficiarioService beneficiarioService;
    @Autowired
    EstatusPagoService estatusPagoService;
    @Autowired
    BitacoraPagoService bitacoraPagoService;

    @RequestMapping(value = {"/envios"}, method = RequestMethod.GET)
    public String envios(ModelMap model) {
        if (!estaUsuarioAnonimo()) {
            //trae los datos de la tabla entidad
            List<InstrumentoMonetario> lInstrumentoMonetario = instrumentomonetarioService.showInstrumento();
            List<MonedaDivisa> lMonedaDivisa = monedaDivisaService.showMonedaDivisa();
            List<TipoServicio> lTipoServicio = tipoServicioService.showTipoServicio();
            List<Giro> lGiro = giroService.showGiro();
            List<ActividadEco> lActividadEconomica = actividadEconomicaService.showActividadEconomica();
            List<TipoIdentidad> lTipoIdentidad = tipoIdentidadService.showTipoIdentidad();
            List<EstatusIdentificacion> lEstatusIdentificacion = estatusIdentificacionService.showEstatusIdentficacion();
            List<CodigoPostal> lCodigoPostal = codigoPostalService.showCodigoPostal();
            List<Sexo> lSexo = sexoService.showSexo();
            List<TipoTelefono> lTipoTelefono = tipoTelefonoService.showTipoTelefono();
            List<Ciudad> lCiudad = ciudadService.showCiudad();
            List<Estado> lEstado = estadoService.showEstado();
            // enviar los datos JSP
            model.addAttribute("lCodigoPostal", lCodigoPostal);
            model.addAttribute("lSexo", lSexo);
            model.addAttribute("lTipoTelefono", lTipoTelefono);
            model.addAttribute("lCiudad", lCiudad);
            model.addAttribute("lInstrumentoMonetario", lInstrumentoMonetario);
            model.addAttribute("lModendaDivisa", lMonedaDivisa);
            model.addAttribute("lTipoServicio", lTipoServicio);
            model.addAttribute("lGiro", lGiro);
            model.addAttribute("lActividadEconomica", lActividadEconomica);
            model.addAttribute("lTipoIdentidad", lTipoIdentidad);
            model.addAttribute("lEstatusIdentificacion", lEstatusIdentificacion);
            model.addAttribute("lEstado", lEstado);

            return "envios";
        }
        return "login";
    }
    
    @RequestMapping(value = "/envios/datosEnvioFinales", method = RequestMethod.POST)
    public @ResponseBody
    String[] datosEnvioFinales(@RequestParam(value = "datos[]") String datos[]){
    String datosEnvio[] = new String[7];
    CodigoPostal cp = codigoPostalService.buscaClave(Integer.parseInt(datos[0]));
    Ciudad ciudad = ciudadService.buscaId(Integer.parseInt(datos[1]));
    
    datosEnvio[0] = cp.getCiudad().getNombre();
    datosEnvio[1] = cp.getCiudad().getEstado().getNombre();
    datosEnvio[2] = cp.getCiudad().getEstado().getPais().getNombre();
    datosEnvio[3] = ciudad.getNombre();
    datosEnvio[4] = ciudad.getEstado().getPais().getNombre();
    
    return datosEnvio;
    }
    /**
     * Método que sirve para guadar un envió
     *
     * @param datos
     * @return
     * @throws ParseException
     */
    @RequestMapping(value = "/envios/registrarEnvio", method = RequestMethod.POST)
    public @ResponseBody
    String registrarEnvio(@RequestParam(value = "datos[]") String datos[]) throws ParseException {
        if (!estaUsuarioAnonimo()) {
            Pago pago = new Pago();
            ValorMoneda valormoneda = new ValorMoneda();
            Date fecha = new Date();
            Beneficiario beneficiario = new Beneficiario();
            Comision comison = new Comision();
            Beneficiario buscaBeneficiario = null;

            if (!datos[8].equals("")) {
                buscaBeneficiario = beneficiarioService
                        .beneficiario(Integer.parseInt(datos[8]));
            } else if (!datos[5].equals("") && !datos[6].equals("") && !datos[7].equals("")) {
                Persona idPersona = personaService
                        .idPersona(datos[5].trim(), datos[6].trim(), datos[7].trim());
                if (idPersona != null) {
                    buscaBeneficiario = beneficiarioService
                            .beneficiario(Integer.parseInt(datos[8]));
                }
            }

            MonedaDivisa lMonedaDivisa = monedaDivisaService
                    .buscaMonedaDivisa(Integer.parseInt(datos[1]));
            Cliente clienteExistente = null;
            if (!datos[10].equals("")) {
                //El arreglo datos en la posición 10 trae la clave  o número de 
                //cuenta de una Persona Física
                clienteExistente = clienteService.buscaClave(datos[10]);
            } else {
                //El arreglo datos en la posición 28 trae la clave   o número de 
                //cuenta de una Persona Moral
                clienteExistente = clienteService.buscaClave(datos[28]);
            }

            //datos que se insertan en la tabla pago
            pago.setCantidadenviada(Integer.parseInt(datos[0]));
            String claveRemesa = generaClaveRemesa();
            pago.setClavepago(claveRemesa);
            pago.setFechahoraregistro(fecha);
            pago.setMonedadivisaid(lMonedaDivisa);
            valormoneda.setFecha(fecha);
            valormoneda.setMonto(datos[2]);
            pago.setValormonedaid(valormoneda);

            //Datos del beneficiario
            if (buscaBeneficiario == null) {
                beneficiario = insertaBeneficiario(datos);
                pago.setBeneficiarioid(beneficiario);
            } else {
                beneficiario = actualizaBeneficiario(datos);
                pago.setBeneficiarioid(beneficiario);
            }

            //Datos del cliente
            if (clienteExistente == null) {
                Cliente cliente = generaCliente(datos);
                pago.setClienteid(cliente);
            } else {
                Cliente cliente = actualizaCliente(datos);
                pago.setClienteid(cliente);
            }
            //Datos de la comsión por pago
            comison.setComision(Double.parseDouble(datos[45]));
            comison.setPagoid(pago);
            comisionService.save(comison);
            if (pagoService.save(pago)) {
                bitacoraPagos("Enviado", pago);
                return "exito";
            } else {
                return "error";
            }
        }
        return "errorAcceso";
    }

    /*metodo para insertar a Bitacora de Pago */
    public String bitacoraPagos(String metodo, Pago pago) {
        if (!estaUsuarioAnonimo()) {
            BitacoraPago bitaPago = new BitacoraPago();
            Date fecha = new Date();
            //Trae el usuario que ha inciado sesion
            Usuario usuarioid = usuarioService.busquedaNinckname(usuarioEnSesion());
            //del usuario se trae el id
            usuarioid.getUsuarioid();
            int estatusPag = 0;
            CausaRechazo causa = new CausaRechazo();
            //causa.setDescripcion("expiro el dia");
            causa.setBitapagoid(bitaPago);
            //dependiendo el metodo ejecutado se pasa el id de la accion realizada
            switch (metodo) {
                case "Pagado":
                    estatusPag = 1;
                    break;
                case "Enviado":
                    estatusPag = 2;
                    break;
                case "Cancelado":
                    estatusPag = 3;
                    break;
                case "Rechazado":
                    estatusPag = 4;
                    break;
                default:
                    break;
            }
            //se hace el insert a la tabla bitacoraAccionesUsuario
            EstatusPago estatus = estatusPagoService.buscaId(estatusPag);
            estatus.getEstatusid();
            bitaPago.setUsuarioid(usuarioid);
            bitaPago.setFecha(fecha);
            bitaPago.setEstatusid(estatus);
            bitaPago.setPagoid(pago);
            if (bitacoraPagoService.save(bitaPago)) {
                return "exito";
            } else {
                return "error";
            }
        }
        return "login";
    }

    @RequestMapping(value = "/envios/datosRemesadoraPagadora", method = RequestMethod.POST)
    public @ResponseBody
    List<Sucursal> datosRemesadoraPagadora(@RequestParam(value = "datos") String datos) {
        List<Sucursal> lSucursal = null;
        lSucursal = sucursalService.sucursalPagadora(Integer.parseInt(datos));
        return lSucursal;
    }
    
    @RequestMapping(value = "/envios/calculaCargos", method = RequestMethod.POST)
    public @ResponseBody
    String  calculaCargos(@RequestParam(value = "datos") String datos) {
        MonedaDivisa moneda = monedaDivisaService.buscaMonedaDivisa(Integer.parseInt(datos));
        String nombreMoneda = moneda.getNombremoneda();
        
        return nombreMoneda;
    }

    /**
     * Método que sirve para generar la clave de la remesa
     * @return String
     */
    public String generaClaveRemesa() {
        String claveRemesa = "";
        if (pagoService.claveRemesa() != null) {
            claveRemesa = pagoService.claveRemesa().getClavepago();
        }
        String nuevaClave = "";
        int numero;
        if (claveRemesa.equals("")) {
            nuevaClave = "T000000001";
        } else {
            //Esta parte de la cadena se queda con DH-
            String inicio = claveRemesa.substring(0, 1);
            //Solo toma la parte de los números despues de el guión 
            String fin = claveRemesa.substring(2, 10);
            //Parseamos el número devuelto a entero para poder sumar una unidad
            numero = Integer.parseInt(fin);
            numero = numero + 1;
            //se le aplica el formato Formatter para que se rellene de ceros a la
            // izquierda hasta llegar a una cantidad de 9 unidades.
            Formatter fmt = new Formatter();
            fmt.format("%09d", numero);
            nuevaClave = inicio + String.valueOf(fmt);
        }

        return nuevaClave;
    }

    /**
     * Método que retorna los datos de un beneficiario
     *
     * @param datos
     * @return
     */
    @RequestMapping(value = "/envios/seleccionaBeneficiario", method = RequestMethod.POST)
    public @ResponseBody
    String[] seleccionaBeneficiario(@RequestParam(value = "datos[]") String datos[]) {
        Beneficiario buscaBeneficiario = null;
        String datosQuienEnvia[] = new String[14];
        Persona buscaPersona = personaService.buscaPersonaID(Integer.parseInt(datos[0]));
        if (buscaPersona != null) {
            buscaBeneficiario = beneficiarioService
                    .beneficiario(buscaPersona.getPersonaid());
        }
        /*else {
            buscaBeneficiario = beneficiarioService.clave(datos[0]);
        }*/

        datosQuienEnvia[0] = buscaBeneficiario.getPersonaid().getNombre();
        datosQuienEnvia[1] = buscaBeneficiario.getPersonaid().getApaterno();
        datosQuienEnvia[2] = buscaBeneficiario.getPersonaid().getAmaterno();
        /*if (buscaPersona != null) {
            datosQuienEnvia[3] = buscaBeneficiario.getPersonaid().getCurp();
        } else {
            datosQuienEnvia[3] = buscaBeneficiario.getClave();
        }*/

        datosQuienEnvia[3] = buscaBeneficiario.getPersonaid().getSexoid()
                .getSexoid().toString();
        datosQuienEnvia[4] = buscaBeneficiario.getTelefonoid().getNumTelefono();
        int tipo;
        String tipoString = "";
        if (buscaBeneficiario.getTelefonoid().getTipoid() != null) {
            tipo = buscaBeneficiario.getTelefonoid().getTipoid().getTipoid();
            tipoString = String.valueOf(tipo);
        } else {
            tipoString = "0";
        }
        datosQuienEnvia[5] = tipoString;
        /*datosQuienEnvia[7] = buscaBeneficiario.getDireccionid().getCalle();
        datosQuienEnvia[8] = buscaBeneficiario.getDireccionid().getColonia();
        int cp = buscaBeneficiario.getDireccionid().getCodigopostalid().getCodigopostalid();
        String cpString = String.valueOf(cp);
        datosQuienEnvia[9] = cpString;
        datosQuienEnvia[10] = buscaBeneficiario.getDireccionid()
                .getCodigopostalid().getCiudad().getCiudadid().toString();
        datosQuienEnvia[11] = buscaBeneficiario.getDireccionid()
                .getCodigopostalid().getCiudad().getEstado().getEstadoid().toString();
        int tipoIdentificacion = buscaBeneficiario.getTipoIdentidad().getIdentificacionid();
        String tipoIdentificacionString = String.valueOf(tipoIdentificacion);
        datosQuienEnvia[12] = tipoIdentificacionString;*/
        int idPersona = buscaBeneficiario.getPersonaid().getPersonaid();
        String idPersonaString = String.valueOf(idPersona);
        datosQuienEnvia[6] = idPersonaString;

        return datosQuienEnvia;
    }

    /**
     * Método que actualiza un beneficiario
     *
     * @param datos
     * @return
     */
    public Beneficiario actualizaBeneficiario(String datos[]) {
        Beneficiario buscaBeneficiario = null;
        Sexo lSexoBeneficiario = null;
        TipoTelefono tipo = null;
        if (!datos[9].equals("")) {
            lSexoBeneficiario
                    = sexoService.buscaClave(Integer.parseInt(datos[9]));
        }
        if (!datos[47].equals("")) {
            tipo = tipoTelefonoService
                    .buscaClave(Integer.parseInt(datos[47]));
        }
        if (!datos[8].equals("")) {
            buscaBeneficiario = beneficiarioService
                    .beneficiario(Integer.parseInt(datos[8]));
        } else if (!datos[5].equals("") && !datos[6].equals("") && !datos[7].equals("")) {
            Persona idPersona = personaService
                    .idPersona(datos[5].trim(), datos[6].trim(), datos[7].trim());
            if (idPersona != null) {
                buscaBeneficiario = beneficiarioService
                        .beneficiario(Integer.parseInt(datos[8]));
            }
        }
        buscaBeneficiario.getPersonaid().setNombre(datos[5].trim());
        buscaBeneficiario.getPersonaid().setApaterno(datos[6].trim());
        buscaBeneficiario.getPersonaid().setAmaterno(datos[7].trim());
        buscaBeneficiario.getPersonaid().setSexoid(lSexoBeneficiario);
        buscaBeneficiario.getTelefonoid().setNumTelefono(datos[46]);
        buscaBeneficiario.getTelefonoid().setTipoid(tipo);
        
        beneficiarioService.update(buscaBeneficiario);
        return buscaBeneficiario;
    }

    /**
     * Método que inserta a un beneficiario
     *
     * @param datos
     * @return Objeto beneficiario
     */
    public Beneficiario insertaBeneficiario(String datos[]) {
        Beneficiario beneficiario = new Beneficiario();
        Persona persona = new Persona();
        Telefono telefono = new Telefono();
        TipoTelefono tipo = null;
        Sexo lSexoBeneficiario = null;
        if (!datos[9].equals("")) {
            lSexoBeneficiario
                    = sexoService.buscaClave(Integer.parseInt(datos[9]));
        }
        if (!datos[47].equals("")) {
            tipo = tipoTelefonoService
                    .buscaClave(Integer.parseInt(datos[47]));
        }
        persona.setNombre(datos[5].trim());
        persona.setApaterno(datos[6].trim());
        persona.setAmaterno(datos[7].trim());
        if (lSexoBeneficiario != null) {
            persona.setSexoid(lSexoBeneficiario);
        }
        if (!datos[46].equals("")) {
            telefono.setNumTelefono(datos[46]);
            telefono.setTipoid(tipo);
        }
        beneficiario.setPersonaid(persona);
        beneficiario.setTelefonoid(telefono);

        beneficiarioService.save(beneficiario);

        return beneficiario;
    }

    /**
     * Método que retorna la información de la empresa que envía
     *
     * @param datos
     * @return
     */
    @RequestMapping(value = "/envios/informacionQuienEnvia", method = RequestMethod.POST)
    public @ResponseBody
    String[] informacionQuienEnvia(@RequestParam(value = "datos") String datos) {
        String datosQuienEnvia[] = new String[5];
        Usuario usuarioid = usuarioService.busquedaNinckname(usuarioEnSesion());

        datosQuienEnvia[0] = usuarioid.getSucursalid().getNombresucursal();
        datosQuienEnvia[1] = usuarioid.getSucursalid().getDireccionid()
                .getCodigopostalid().getCiudad().getNombre();
        datosQuienEnvia[2] = usuarioid.getSucursalid().getDireccionid()
                .getCodigopostalid().getCiudad().getEstado()
                .getNombre();
        datosQuienEnvia[3] = usuarioid.getSucursalid().getDireccionid()
                .getCodigopostalid().getCiudad().getEstado()
                .getPais().getNombre();
        return datosQuienEnvia;
    }

    public Cliente generaCliente(String datos[]) throws ParseException {
        Cliente cliente = new Cliente();
        Direccion direccionCliente = new Direccion();
        Telefono telefonoCliente = new Telefono();
        PersonaFisica personaF = new PersonaFisica();
        PersonaMoral personaMoral = new PersonaMoral();
        Persona personaMor = new Persona();
        Persona personaFisica = new Persona();
        CodigoPostal cpCliente = null;
        Sexo lSexo = null;
        SimpleDateFormat formatoFecha = new SimpleDateFormat("yyyy-MM-dd");
        String strFecha;
        String claveUsuario = "";
        Date fechaNacimientoFisica = null;
        Date fechaConstitucion = null;
        Giro giro = null;
        ActividadEco actividad = null;
        EstatusIdentificacion estatusIdentificacion = null;
        TipoIdentidad tipoIdentidad = null;
        TipoTelefono tipoTelefono = null;

        //Condicón que obtiene el código postal y sexo de un cliente física o moral    
        if (Integer.parseInt(datos[15]) != 0
                && Integer.parseInt(datos[22]) != 0) {
            //Código postal y sexo de la persona física
            cpCliente = codigoPostalService
                    .buscaClave(Integer.parseInt(datos[15]));
            lSexo = sexoService.buscaClave(Integer.parseInt(datos[22]));
            actividad = actividadEconomicaService
                    .buscaActividadEconomica(Integer.parseInt(datos[25]));
            estatusIdentificacion = estatusIdentificacionService
                    .buscaEstatusIdentificacion(Integer.parseInt(datos[24]));
            tipoIdentidad = tipoIdentidadService
                    .buscaTipoIdentidad(Integer.parseInt(datos[23]));
            tipoTelefono = tipoTelefonoService
                    .buscaClave(Integer.parseInt(datos[27]));

        } else {
            //Código postal y sexo de la persona moral
            cpCliente = codigoPostalService
                    .buscaClave(Integer.parseInt(datos[38]));
            lSexo = sexoService.buscaClave(Integer.parseInt(datos[33]));
            giro = giroService.buscaId(Integer.parseInt(datos[42]));
        }

        claveUsuario = generaClave();
        cliente.setClave(claveUsuario);

        if (!datos[11].equals("") && !datos[12].equals("")
                && !datos[13].equals("") && !datos[14].equals("")) {
            cliente.setCorreoelectronico(datos[11]);
            cliente.setRfc(datos[12]);
            direccionCliente.setCalle(datos[13]);
            direccionCliente.setColonia(datos[14]);
            direccionCliente.setCodigopostalid(cpCliente);
            telefonoCliente.setNumTelefono(datos[26]);
            telefonoCliente.setTipoid(tipoTelefono);
            cliente.setTelefonoId(telefonoCliente);
        } else {
            cliente.setCorreoelectronico(datos[34]);
            cliente.setRfc(datos[35]);
            direccionCliente.setCalle(datos[36]);
            direccionCliente.setColonia(datos[37]);
            direccionCliente.setCodigopostalid(cpCliente);
        }

        cliente.setDireccionid(direccionCliente);

        if (!datos[17].equals("")) {
            strFecha = datos[17];
            fechaNacimientoFisica = formatoFecha.parse(strFecha);
        } else {
            strFecha = datos[40];
            fechaConstitucion = formatoFecha.parse(strFecha);
        }

        //Datos de la persona física 
        personaF.setIdentificacionoficial(datos[16]);
        personaF.setFechanacimiento(fechaNacimientoFisica);
        personaFisica.setNombre(datos[18]);
        personaFisica.setApaterno(datos[19]);
        personaFisica.setAmaterno(datos[20]);
        personaFisica.setCurp(datos[21]);
        personaFisica.setSexoid(lSexo);
        personaF.setPersonaid(personaFisica);
        personaF.setActividadid(actividad);
        personaF.setEstatusidentificacionid(estatusIdentificacion);
        personaF.setTipoidentidadid(tipoIdentidad);
        personaF.setClienteid(cliente);

        //Datos de la persona Moral
        personaMoral.setFechaconstitucion(fechaConstitucion);
        personaMoral.setNumerofirmaavanzada(datos[41]);
        personaMoral.setRazonsocial(datos[39]);
        personaMoral.setClienteid(cliente);
        personaMoral.setGiroid(giro);
        personaMor.setNombre(datos[29]);
        personaMor.setApaterno(datos[30]);
        personaMor.setAmaterno(datos[31]);
        personaMor.setCurp(datos[32]);
        personaMor.setSexoid(lSexo);
        personaMoral.setPersonaid(personaMor);

        if (!personaF.getIdentificacionoficial().equals("")) {
            personaFisicaService.save(personaF);
            return personaF.getClienteid();
        } else {
            personaMoralService.save(personaMoral);
            return personaMoral.getClienteid();
        }
    }

    public Cliente actualizaCliente(String datos[]) throws ParseException {
        Cliente clienteExistente = null;
        int clienteid;
        PersonaFisica personaFisica = null;
        PersonaMoral personaMoral = null;
        CodigoPostal cpCliente = null;
        Sexo lSexo = null;
        ActividadEco actividad = null;
        EstatusIdentificacion estatusIdentificacion = null;
        TipoIdentidad tipoIdentidad = null;
        SimpleDateFormat formatoFecha = new SimpleDateFormat("yyyy-MM-dd");
        String strFecha = "";
        Date fechaNacimientoFisica = null;
        Date fechaConstitucion = null;
        Giro giro = null;
        TipoTelefono tipoTelefono = null;

        if (!datos[10].equals("")) {
            clienteExistente = clienteService.buscaClave(datos[10]);
            clienteid = clienteExistente.getClienteid();
        } else {
            clienteExistente = clienteService.buscaClave(datos[28]);
            clienteid = clienteExistente.getClienteid();
        }
        if (!datos[17].equals("")) {
            strFecha = datos[17];
            fechaNacimientoFisica = formatoFecha.parse(strFecha);
        } else {
            strFecha = datos[40];
            fechaConstitucion = formatoFecha.parse(strFecha);
        }
        if (personaFisicaService.buscaCliente(clienteid) != null) {
            personaFisica = personaFisicaService.buscaCliente(clienteid);
            cpCliente = codigoPostalService.buscaClave(Integer.parseInt(datos[15]));
            lSexo = sexoService.buscaClave(Integer.parseInt(datos[22]));
            actividad = actividadEconomicaService.buscaActividadEconomica(Integer.parseInt(datos[25]));
            estatusIdentificacion = estatusIdentificacionService.buscaEstatusIdentificacion(Integer.parseInt(datos[24]));
            tipoIdentidad = tipoIdentidadService.buscaTipoIdentidad(Integer.parseInt(datos[23]));
            tipoTelefono = tipoTelefonoService.buscaClave(Integer.parseInt(datos[27]));
            //Actualización de la persona física
            personaFisica.getClienteid().setCorreoelectronico(datos[11]);
            personaFisica.getClienteid().setRfc(datos[12]);
            personaFisica.getClienteid().getDireccionid().setCalle(datos[13]);
            personaFisica.getClienteid().getDireccionid().setColonia(datos[14]);
            personaFisica.getClienteid().getDireccionid().setCodigopostalid(cpCliente);
            personaFisica.getClienteid().getTelefonoId().setNumTelefono(datos[26]);
            personaFisica.getClienteid().getTelefonoId().setTipoid(tipoTelefono);
            personaFisica.setIdentificacionoficial(datos[16]);
            personaFisica.setFechanacimiento(fechaNacimientoFisica);
            personaFisica.getPersonaid().setNombre(datos[18]);
            personaFisica.getPersonaid().setApaterno(datos[19]);
            personaFisica.getPersonaid().setAmaterno(datos[20]);
            personaFisica.getPersonaid().setCurp(datos[21]);
            personaFisica.getPersonaid().setSexoid(lSexo);
            personaFisica.setActividadid(actividad);
            personaFisica.setEstatusidentificacionid(estatusIdentificacion);
            personaFisica.setTipoidentidadid(tipoIdentidad);
        } else if (personaMoralService.buscaCliente(clienteid) != null) {
            personaMoral = personaMoralService.buscaCliente(clienteid);
            cpCliente = codigoPostalService.buscaClave(Integer.parseInt(datos[38]));
            lSexo = sexoService.buscaClave(Integer.parseInt(datos[33]));
            giro = giroService.buscaId(Integer.parseInt(datos[42]));
            //Actualización de la persona moral
            personaMoral.getPersonaid().setNombre(datos[29]);
            personaMoral.getPersonaid().setApaterno(datos[30]);
            personaMoral.getPersonaid().setAmaterno(datos[31]);
            personaMoral.getPersonaid().setCurp(datos[32]);
            personaMoral.getPersonaid().setSexoid(lSexo);
            personaMoral.getClienteid().setCorreoelectronico(datos[34]);
            personaMoral.getClienteid().setRfc(datos[35]);
            personaMoral.getClienteid().getDireccionid().setCalle(datos[36]);
            personaMoral.getClienteid().getDireccionid().setColonia(datos[37]);
            personaMoral.getClienteid().getDireccionid().setCodigopostalid(cpCliente);
            personaMoral.setFechaconstitucion(fechaConstitucion);
            personaMoral.setNumerofirmaavanzada(datos[41]);
            personaMoral.setRazonsocial(datos[39]);
            personaMoral.setGiroid(giro);
        }

        if (personaFisica != null) {
            personaFisicaService.update(personaFisica);
            return personaFisica.getClienteid();
        } else {
            personaMoralService.update(personaMoral);
            return personaMoral.getClienteid();
        }

    }

    /**
     *
     * @param datos
     * @return retorna un arreglo de cadena con los datos de un cliente en caso
     * de que este exista
     */
    @RequestMapping(value = "/envios/detectaCambio", method = RequestMethod.POST)
    public @ResponseBody
    String[] detectaCambio(@RequestParam(value = "datos[]") String datos[]) {
        String datosPersona[] = new String[30];
        String codP = "";
        String tipoTel = "";
        int cp2 = 0;
        int tipo = 0;
        String filtro = "";
        String filtroBusqueda = datos[0];
        Integer id = 0;
        PersonaFisica personaFisica = null;
        PersonaMoral personaMoral = null;
        List<String> lPersonaMoral = new ArrayList<>();
        Persona persona = null;
        if(filtroBusqueda.equals("clavePersonaFisica")
                || filtroBusqueda.equals("noClienteMoral")) {
            Cliente cliente = clienteService.buscaClave(datos[1]);
            if (cliente != null) {
                id = cliente.getClienteid();
            }
            filtro = "clienteid";
            if (filtroBusqueda.equals("clavePersonaFisica")) {
                personaFisica = personaFisicaService.buscaPersona(filtro, id);
            } else {
                lPersonaMoral = personaMoralService.buscaPersonaMoral(filtro, id);
            }

        } else if (filtroBusqueda.equals("curpfisica")) {
            persona = personaService.buscaPersona(datos[1]);
            if (persona != null) {
                id = persona.getPersonaid();
            }
            filtro = "personaid";
            personaFisica = personaFisicaService.buscaPersona(filtro, id);
        } else if (filtroBusqueda.equals("rfcfisica")) {
            Cliente clienterfc = clienteService.buscaRFC(datos[1]);
            if (clienterfc != null) {
                id = clienterfc.getClienteid();
            }
            filtro = "clienteid";
            personaFisica = personaFisicaService.buscaPersona(filtro, id);
        } else if (filtroBusqueda.equals("noidentificacion")) {
            personaFisica = personaFisicaService.buscaNoidentificacion(datos[1]);
        }
        Usuario usuarioid = usuarioService.busquedaNinckname(usuarioEnSesion());

        String nombreSucursal = usuarioid.getSucursalid().getNombresucursal();

        if (personaFisica != null) {
            CodigoPostal cp = personaFisica.getClienteid().getDireccionid().getCodigopostalid();
            TipoTelefono tel = personaFisica.getClienteid().getTelefonoId().getTipoid();
            cp2 = cp.getCodigopostalid();
            tipo = tel.getTipoid();
            codP = String.valueOf(cp2);
            tipoTel = String.valueOf(tipo);
            datosPersona[0] = "personaFisica";
            datosPersona[1] = personaFisica.getPersonaid().getNombre();
            datosPersona[2] = personaFisica.getPersonaid().getApaterno();
            datosPersona[3] = personaFisica.getPersonaid().getAmaterno();
            datosPersona[4] = personaFisica.getPersonaid().getCurp();
            datosPersona[5] = personaFisica.getPersonaid().getSexoid().getSexoid().toString();
            datosPersona[6] = personaFisica.getFechanacimiento().toString();
            datosPersona[7] = personaFisica.getTipoidentidadid().getIdentificacionid().toString();
            datosPersona[8] = personaFisica.getEstatusidentificacionid().getEstatusidentid().toString();
            datosPersona[9] = personaFisica.getActividadid().getActividadid().toString();
            datosPersona[10] = personaFisica.getClienteid().getCorreoelectronico();
            datosPersona[11] = personaFisica.getClienteid().getRfc();
            datosPersona[12] = codP;
            datosPersona[13] = personaFisica.getClienteid().getDireccionid().getCalle();
            datosPersona[14] = personaFisica.getClienteid().getDireccionid().getColonia();
            datosPersona[15] = personaFisica.getClienteid().getClave();
            datosPersona[16] = personaFisica.getIdentificacionoficial().toString();
            datosPersona[17] = nombreSucursal;
            datosPersona[18] = personaFisica.getClienteid().getTelefonoId().getNumTelefono();
            datosPersona[19] = tipoTel;
            datosPersona[20] = personaFisica.getClienteid().getDireccionid().getCodigopostalid().getCiudad().getNombre();
            datosPersona[21] = personaFisica.getClienteid().getDireccionid().getCodigopostalid().getCiudad().getEstado().getNombre();
            datosPersona[22] = personaFisica.getClienteid().getDireccionid().getCodigopostalid().getClave();
            datosPersona[23] = personaFisica.getTipoidentidadid().getNombre();
            datosPersona[24] = personaFisica.getClienteid().getDireccionid().getCodigopostalid().getCiudad().getCiudadid().toString();
            datosPersona[25] = personaFisica.getClienteid().getDireccionid().getCodigopostalid().getCiudad().getEstado().getEstadoid().toString();
        } else if (persona != null && personaFisica == null) {
            datosPersona[0] = "soloPersona";
            datosPersona[1] = persona.getNombre();
            datosPersona[2] = persona.getApaterno();
            datosPersona[3] = persona.getApaterno();
            datosPersona[4] = persona.getCurp();
            datosPersona[5] = persona.getSexoid().getSexoid().toString();

            /*Iterator iterator = lPersonaMoral.iterator();
            while (iterator.hasNext()) {
                Object[] tuple = (Object[]) iterator.next();
                int sexo = (int) tuple[5];
                String sexol = String.valueOf(sexo);
                int cp = (int) tuple[10];
                String cpl = String.valueOf(cp);
                int giro = (int) tuple[5];
                String girol = String.valueOf(giro);
                datosPersona[0] = "personaMoral";
                datosPersona[1] = (String) tuple[0];//Clave
                datosPersona[2] = (String) tuple[1];//Fecha
                datosPersona[3] = (String) tuple[2];//Nombre
                datosPersona[4] = (String) tuple[3];
                datosPersona[5] = (String) tuple[4];
                datosPersona[6] = sexol;
                datosPersona[7] = (String) tuple[6];
                datosPersona[8] = (String) tuple[7];
                datosPersona[9] = (String) tuple[8];
                datosPersona[10] = (String) tuple[9];
                datosPersona[11] = cpl;
                datosPersona[12] = (String) tuple[11];
                datosPersona[13] = (String) tuple[12];
                datosPersona[14] = (String) tuple[13];
                datosPersona[15] = girol;
                datosPersona[16] = nombreSucursal;
            }*/
        }

        return datosPersona;
    }

    /**
     * Método que genera la nueva clave del cliente
     *
     * @return
     */
    public String generaClave() {
        String clave = "";
        if (clienteServiceClave.clave() != null) {
            clave = clienteServiceClave.clave().getClave();
        }
        String nuevaClave = "";
        int numero;
        if (clave.equals("")) {
            nuevaClave = "DH-00001";
        } else {
            //Esta parte de la cadena se queda con DH-
            String inicio = clave.substring(0, 3);
            //Solo toma la parte de los números despues de el guión 
            String fin = clave.substring(3, 8);
            //Parseamos el número devuelto a entero para poder sumar una unidad
            numero = Integer.parseInt(fin);
            numero = numero + 1;
            //se le aplica el formato Formatter para que se rellene de ceros a la
            // izquierda hasta llegar a una cantidad de 5 unidades.
            Formatter fmt = new Formatter();
            fmt.format("%05d", numero);
            nuevaClave = inicio + String.valueOf(fmt);
        }

        return nuevaClave;
    }

    @RequestMapping(value = "/envios/detectaCambioCombo", method = RequestMethod.POST)
    public @ResponseBody
    void detectaCambioCombo(@RequestParam(value = "datos[]") String datos[], ModelMap model) {
        Ciudad ciudadId;
        Estado estadoId;
        if (datos[1].equals("codigoPostal")) {
            ciudadId = codigoPostalService.buscaClave(Integer.parseInt(datos[0])).getCiudad();
            estadoId = ciudadService.buscaId(ciudadId.getCiudadid()).getEstado();

            Ciudad lCiudad = ciudadId;
            model.addAttribute("lCiudad", lCiudad);

            Estado lEstado = estadoId;
            model.addAttribute("lEstado", lEstado);
        }

    }

    @RequestMapping(value = "/envios/listaBeneficiarios", method = RequestMethod.POST)
    public @ResponseBody
    List<String> listaBeneficiarios(@RequestParam(value = "datos") String datos) {
        List<String> lBeneficiarios = null;
        lBeneficiarios = personaService.lBeneficiarios(datos);
        return lBeneficiarios;
    }

    /**
     * Este metodo traera de la sesion iniciada.
     *
     * @return
     */
    public String usuarioEnSesion() {

        Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();

        String nicknamePrincipal = null;

        if (principal instanceof UserDetails) {
            //Es igual al usuario que esta en sesion
            return nicknamePrincipal = ((UserDetails) principal).getUsername();
        } else {
            //Es igual a usuario anonimo
            return nicknamePrincipal = principal.toString();
        }
    }

    /**
     * Este metodo verificara que un usuario este autenticado correctamente
     */
    private boolean estaUsuarioAnonimo() {
        final Authentication autenticacion = SecurityContextHolder.getContext().getAuthentication();

        AuthenticationTrustResolver authenticationTrustResolver = new AuthenticationTrustResolverImpl();
        return authenticationTrustResolver.isAnonymous(autenticacion);
    }

}
